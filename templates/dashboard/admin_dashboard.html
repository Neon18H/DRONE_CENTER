{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="content-header mb-4">
  <div class="container-fluid">
    <div class="row align-items-center">
      <div class="col-sm-6">
        <h1 class="m-0">Command Center</h1>
      </div>
      <div class="col-sm-6 text-end">
        <span class="text-muted">Última actualización: {{ now|date:"Y-m-d H:i" }}</span>
      </div>
    </div>
  </div>
</div>

{% if requires_migrations %}
  <div class="hud-alert hud-alert-warning">
    Ejecuta migraciones para habilitar el panel completo.
  </div>
{% endif %}

<div class="row g-4">
  <div class="col-md-3">
    <div class="hud-card hud-metric">
      <div class="metric-label">Drone Fleet Status</div>
      <div class="metric-value">{{ drones_online }}</div>
      <div class="metric-label">Online</div>
      <div class="metric-icon"><i class="fas fa-satellite-dish"></i></div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="hud-card hud-metric">
      <div class="metric-label">Disponibles</div>
      <div class="metric-value">{{ drones_available }}</div>
      <div class="metric-icon"><i class="fas fa-check-circle"></i></div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="hud-card hud-metric">
      <div class="metric-label">En Uso</div>
      <div class="metric-value">{{ drones_in_use }}</div>
      <div class="metric-icon"><i class="fas fa-fighter-jet"></i></div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="hud-card hud-metric">
      <div class="metric-label">Mantenimiento</div>
      <div class="metric-value">{{ drones_maintenance }}</div>
      <div class="metric-icon"><i class="fas fa-tools"></i></div>
    </div>
  </div>
</div>

<div class="row g-4 mt-1">
  <div class="col-lg-3 col-md-6">
    <div class="hud-card">
      <div class="hud-header">
        <h3 class="hud-title">Lost Link</h3>
        <span class="hud-badge lost">Alert</span>
      </div>
      <div class="metric-value">{{ drones_lost_link }}</div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="hud-card">
      <div class="hud-header">
        <h3 class="hud-title">Pilotos Activos</h3>
        <span class="hud-badge online">Online</span>
      </div>
      <div class="metric-value">{{ pilots_active }}</div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="hud-card">
      <div class="hud-header">
        <h3 class="hud-title">Alertas Abiertas</h3>
        <span class="hud-badge alert">Active</span>
      </div>
      <div class="metric-value">{{ alerts_open }}</div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="hud-card">
      <div class="hud-header">
        <h3 class="hud-title">Críticas</h3>
        <span class="hud-badge lost">Critical</span>
      </div>
      <div class="metric-value">{{ alerts_critical }}</div>
    </div>
  </div>
</div>

<div class="row g-4 mt-1">
  <div class="col-lg-8">
    <div class="hud-card">
      <div class="hud-header">
        <h3 class="hud-title">Active Operations</h3>
        <span class="hud-badge active">Live Feed</span>
      </div>
      <div class="live-feed">
        <div>
          <div>Operational Grid Online</div>
          <small class="text-muted">Overlay táctico listo para despliegue.</small>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="hud-card">
      <div class="hud-header">
        <h3 class="hud-title">Turnos de Hoy</h3>
        <span class="hud-badge active">Active</span>
      </div>
      <div class="table-responsive">
        <table class="table hud-table table-dark table-striped mb-0">
          <thead>
            <tr>
              <th>Piloto</th>
              <th>Drone</th>
              <th>Estado</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for shift in shifts_today %}
              <tr>
                <td>{{ shift.pilot.username }}</td>
                <td>{{ shift.drone.serial }}</td>
                <td><span class="badge bg-secondary">{{ shift.status }}</span></td>
                <td class="text-end">
                  {% if shift.status == 'SCHEDULED' %}
                    <form method="post" action="{% url 'admin-shift-activate' shift.id %}" class="d-inline">
                      {% csrf_token %}
                      <input type="hidden" name="next" value="{% url 'admin-dashboard' %}">
                      <button class="btn btn-sm btn-success" type="submit"><i class="fas fa-play"></i></button>
                    </form>
                  {% endif %}
                  <a class="btn btn-sm btn-outline-info" href="{% url 'admin-shift-update' shift.id %}">
                    <i class="fas fa-pen"></i>
                  </a>
                  <form method="post" action="{% url 'admin-shift-cancel' shift.id %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{% url 'admin-dashboard' %}">
                    <button class="btn btn-sm btn-outline-danger" type="submit"><i class="fas fa-ban"></i></button>
                  </form>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="text-center text-muted">Sin turnos.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mt-1">
  <div class="col-lg-7">
    <div class="hud-card">
      <div class="hud-header">
        <h3 class="hud-title">Alerts Overview</h3>
        <form method="get" class="d-flex gap-2">
          <select name="status" class="form-select form-select-sm">
            <option value="">Estado</option>
            {% for value, label in alert_model.Status.choices %}
              <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
          <select name="severity" class="form-select form-select-sm">
            <option value="">Severidad</option>
            {% for value, label in alert_model.Severity.choices %}
              <option value="{{ value }}" {% if severity_filter == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
          <select name="category" class="form-select form-select-sm">
            <option value="">Categoría</option>
            {% for value, label in alert_model.Categories.choices %}
              <option value="{{ value }}" {% if category_filter == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
          <button class="btn btn-sm btn-outline-light" type="submit">Filtrar</button>
        </form>
      </div>
      <div class="table-responsive">
        <table class="table hud-table table-dark table-striped mb-0">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Severidad</th>
              <th>Estado</th>
              <th>Creada</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for alert in alert_queue %}
              <tr>
                <td>{{ alert.category }}</td>
                <td><span class="badge badge-severity-{{ alert.severity|lower }}">{{ alert.severity }}</span></td>
                <td><span class="badge badge-status-{{ alert.status|lower }}">{{ alert.status }}</span></td>
                <td>{{ alert.created_at|date:"H:i" }}</td>
                <td class="text-end">
                  <form method="post" action="{% url 'admin-alert-status' alert.id 'ACK' %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{% url 'admin-dashboard' %}">
                    <button class="btn btn-sm btn-outline-light" type="submit">ACK</button>
                  </form>
                  <form method="post" action="{% url 'admin-alert-status' alert.id 'IN_PROGRESS' %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{% url 'admin-dashboard' %}">
                    <button class="btn btn-sm btn-outline-warning" type="submit">IN PROG</button>
                  </form>
                  <form method="post" action="{% url 'admin-alert-status' alert.id 'RESOLVED' %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{% url 'admin-dashboard' %}">
                    <button class="btn btn-sm btn-outline-success" type="submit">RES</button>
                  </form>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="5" class="text-center text-muted">Sin alertas.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="mt-3 text-end">
        <a class="btn btn-sm btn-outline-light" href="{% url 'admin-alert-center' %}">Ir a inbox</a>
      </div>
    </div>
  </div>
  <div class="col-lg-5">
    <div class="hud-card">
      <div class="hud-header">
        <h3 class="hud-title">Audit Timeline</h3>
        <span class="hud-badge active">Live</span>
      </div>
      <ul class="list-group list-group-flush">
        {% for event in audit_events %}
          <li class="list-group-item bg-transparent text-light border-secondary">
            <div class="d-flex justify-content-between">
              <span><strong>{{ event.actor|default:"Sistema" }}</strong> · {{ event.action }}</span>
              <span class="text-muted">{{ event.created_at|date:"H:i" }}</span>
            </div>
            <small class="text-muted">{{ event.object_type }} #{{ event.object_id }}</small>
          </li>
        {% empty %}
          <li class="list-group-item bg-transparent text-muted">Sin eventos recientes.</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>
{% endblock %}
