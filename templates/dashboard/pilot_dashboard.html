{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="content-header mb-4">
  <div class="container-fluid">
    <div class="row align-items-center">
      <div class="col-sm-6">
        <h1 class="m-0">Pilot Command Console</h1>
      </div>
      <div class="col-sm-6 text-end">
        <span class="text-muted">Estado en tiempo real</span>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-md-6">
    <div class="hud-card">
      <div class="hud-header">
        <h3 class="hud-title">Current Shift</h3>
        <span class="hud-badge active">Active</span>
      </div>
      {% if requires_migrations %}
        <div class="hud-alert hud-alert-warning">Base de datos sin migraciones. Ejecuta migraciones.</div>
      {% endif %}
      {% if shift %}
        <p><strong>Ruta:</strong> {{ shift.route.name }}</p>
        <p><strong>Inicio:</strong> {{ shift.start_at }}</p>
        <p><strong>Fin:</strong> {{ shift.end_at }}</p>
        <p><strong>Estado:</strong> {{ shift.status }}</p>
        <div class="d-flex flex-wrap gap-2">
          {% if current_session %}
            <a href="{% url 'pilot-operation-center' %}" class="btn btn-outline-light">Command Center</a>
            <a href="{% url 'pilot-operation-end' %}" class="btn btn-danger">End Operation</a>
            <a href="{% url 'pilot-operation-notes' current_session.id %}" class="btn btn-secondary">Notas</a>
          {% else %}
            <a href="{% url 'pilot-operation-start' %}" class="btn btn-success">Start Operation</a>
          {% endif %}
        </div>
      {% else %}
        <p>No tienes turno asignado.</p>
      {% endif %}
    </div>
  </div>
  <div class="col-md-6">
    <div class="hud-card">
      <div class="hud-header">
        <h3 class="hud-title">Assigned Drone</h3>
        <span class="hud-badge online">Online</span>
      </div>
      {% if shift %}
        <p><strong>Serial:</strong> {{ shift.drone.serial }}</p>
        <p><strong>Modelo:</strong> {{ shift.drone.model }}</p>
        <p><strong>Estado:</strong> {{ shift.drone.status }}</p>
        <p>
          <strong>Agente:</strong>
          {% if agent_online %}
            <span class="badge bg-success">Online</span>
          {% else %}
            <span class="badge bg-secondary">Offline</span>
          {% endif %}
        </p>
        <p>
          <strong>Misión:</strong>
          {% if current_session %}
            <span class="badge bg-info">Running</span>
          {% else %}
            <span class="badge bg-light text-dark">Idle</span>
          {% endif %}
        </p>
        <p>
          <strong>Último comando:</strong>
          {% if last_command %}
            <span class="badge bg-primary">{{ last_command.command }}</span>
            <span class="badge bg-secondary">{{ last_command.status }}</span>
          {% else %}
            <span class="text-muted">Sin comandos</span>
          {% endif %}
        </p>
      {% else %}
        <p>Sin dron asignado.</p>
      {% endif %}
    </div>
  </div>
</div>

<div class="row g-4 mt-1">
  <div class="col-lg-6">
    <div class="hud-card">
      <div class="hud-header">
        <h3 class="hud-title">Pilot Profile</h3>
        <span class="hud-badge active">Verified</span>
      </div>
      <div class="d-flex align-items-center gap-3">
        {% with display_name=request.user.profile.full_name|default:request.user.username %}
          <div class="hud-avatar">{{ display_name|slice:":2" }}</div>
        {% endwith %}
        <div>
          <p class="mb-1"><strong>{{ request.user.profile.full_name }}</strong></p>
          <p class="mb-1 text-muted">{{ request.user.username }}</p>
          <p class="mb-1"><strong>Teléfono:</strong> {{ request.user.profile.phone|default:"-" }}</p>
          <p class="mb-1"><strong>Badge:</strong> {{ request.user.profile.badge_id|default:"-" }}</p>
          <p class="mb-0"><strong>Estación:</strong> {{ request.user.profile.station|default:"-" }}</p>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="hud-card">
      <div class="hud-header">
        <h3 class="hud-title">Crear alerta</h3>
        <span class="hud-badge alert">Priority</span>
      </div>
      <form method="post" action="{% url 'pilot-alert-create' %}">
        {% csrf_token %}
        {{ alert_form|crispy }}
        <button type="submit" class="btn btn-primary">Enviar alerta</button>
      </form>
    </div>
  </div>
</div>

<div class="row g-4 mt-1">
  <div class="col-12">
    <div class="hud-card">
      <div class="hud-header">
        <h3 class="hud-title">Alertas recibidas</h3>
        <span class="hud-badge active">Inbound</span>
      </div>
      <ul class="list-group list-group-flush">
        {% for alert in alerts_received %}
          <li class="list-group-item bg-transparent text-light border-secondary d-flex justify-content-between">
            <span><strong>{{ alert.category }}</strong> - {{ alert.severity }}</span>
            <span class="text-muted">{{ alert.created_at }}</span>
          </li>
        {% empty %}
          <li class="list-group-item bg-transparent text-muted">Sin alertas.</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>
{% endblock %}
