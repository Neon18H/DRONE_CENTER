{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<h1>Dashboard Piloto</h1>
<div class="row">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header"><h3 class="card-title">Mi turno</h3></div>
      <div class="card-body">
        {% if requires_migrations %}
          <div class="alert alert-warning">Base de datos sin migraciones. Ejecuta migraciones.</div>
        {% endif %}
        {% if shift %}
          <p><strong>Ruta:</strong> {{ shift.route.name }}</p>
          <p><strong>Inicio:</strong> {{ shift.start_at }}</p>
          <p><strong>Fin:</strong> {{ shift.end_at }}</p>
          <p><strong>Estado:</strong> {{ shift.status }}</p>
          {% if current_session %}
            <a href="{% url 'pilot-operation-end' %}" class="btn btn-danger">Finalizar Operación</a>
            <a href="{% url 'pilot-operation-notes' current_session.id %}" class="btn btn-secondary">Notas</a>
          {% else %}
            <a href="{% url 'pilot-operation-start' %}" class="btn btn-success">Iniciar Operación</a>
          {% endif %}
        {% else %}
          <p>No tienes turno asignado.</p>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-header"><h3 class="card-title">Mi dron asignado</h3></div>
      <div class="card-body">
        {% if shift %}
          <p><strong>Serial:</strong> {{ shift.drone.serial }}</p>
          <p><strong>Modelo:</strong> {{ shift.drone.model }}</p>
          <p><strong>Estado:</strong> {{ shift.drone.status }}</p>
          <p>
            <strong>Agente:</strong>
            {% if agent_online %}
              <span class="badge bg-success">ONLINE</span>
            {% else %}
              <span class="badge bg-secondary">OFFLINE</span>
            {% endif %}
          </p>
          <p>
            <strong>Misión:</strong>
            {% if current_session %}
              <span class="badge bg-info">RUNNING</span>
            {% else %}
              <span class="badge bg-light text-dark">IDLE</span>
            {% endif %}
          </p>
          <p>
            <strong>Último comando:</strong>
            {% if last_command %}
              <span class="badge bg-primary">{{ last_command.command }}</span>
              <span class="badge bg-secondary">{{ last_command.status }}</span>
            {% else %}
              <span class="text-muted">Sin comandos</span>
            {% endif %}
          </p>
        {% else %}
          <p>Sin dron asignado.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header"><h3 class="card-title">Mi perfil</h3></div>
  <div class="card-body d-flex align-items-center gap-3">
    {% if request.user.profile.photo %}
      <img src="{{ request.user.profile.photo.url }}" alt="Foto de {{ request.user.profile.full_name }}" class="img-circle elevation-2" width="64" height="64">
    {% else %}
      <div class="text-muted">Sin foto</div>
    {% endif %}
    <div>
      <p class="mb-1"><strong>{{ request.user.profile.full_name }}</strong></p>
      <p class="mb-1 text-muted">{{ request.user.username }}</p>
      <p class="mb-1"><strong>Teléfono:</strong> {{ request.user.profile.phone|default:"-" }}</p>
      <p class="mb-1"><strong>Badge:</strong> {{ request.user.profile.badge_id|default:"-" }}</p>
      <p class="mb-0"><strong>Estación:</strong> {{ request.user.profile.station|default:"-" }}</p>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header"><h3 class="card-title">Crear alerta</h3></div>
  <div class="card-body">
    <form method="post" action="{% url 'pilot-alert-create' %}">
      {% csrf_token %}
      {{ alert_form|crispy }}
      <button type="submit" class="btn btn-primary">Enviar alerta</button>
    </form>
  </div>
</div>

<div class="card">
  <div class="card-header"><h3 class="card-title">Alertas recibidas</h3></div>
  <div class="card-body">
    <ul class="list-group">
      {% for alert in alerts_received %}
        <li class="list-group-item">
          <strong>{{ alert.category }}</strong> - {{ alert.severity }}
          <span class="text-muted">{{ alert.created_at }}</span>
        </li>
      {% empty %}
        <li class="list-group-item">Sin alertas.</li>
      {% endfor %}
    </ul>
  </div>
</div>
{% endblock %}
