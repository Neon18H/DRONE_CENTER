{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="content-header mb-4">
  <div class="container-fluid">
    <div class="row align-items-center">
      <div class="col-sm-6">
        <h1 class="m-0">Operaci√≥n en Curso</h1>
      </div>
      <div class="col-sm-6 text-end">
        <span class="text-muted">Mission Control</span>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-4">
    <div class="hud-card h-100">
      <div class="hud-header">
        <h3 class="hud-title">Mission Control</h3>
        {% if agent_online %}
          <span class="hud-badge online">DRONE ONLINE</span>
        {% else %}
          <span class="hud-badge lost">DRONE OFFLINE</span>
        {% endif %}
      </div>
      <p><strong>Drone status:</strong> {{ shift.drone.status }}</p>
      <p><strong>Last seen:</strong> {{ shift.drone.last_seen|default_if_none:"-" }}</p>
      <p><strong>Operation:</strong> {{ operation_state }}</p>
      <div class="hud-divider"></div>
      <p><strong>Ruta:</strong> {{ shift.route.name }}</p>
      <p><strong>Risk level:</strong> {{ shift.route.risk_level }}</p>
      <div class="hud-divider"></div>
      <p><strong>Comando reciente:</strong></p>
      {% if last_command %}
        <div class="d-flex flex-wrap gap-2">
          <span class="badge bg-primary">{{ last_command.command }}</span>
          <span class="badge bg-secondary">{{ last_command.status }}</span>
        </div>
      {% else %}
        <span class="text-muted">Sin comandos</span>
      {% endif %}
      {% if command_feedback %}
        <p class="mt-3 text-warning">{{ command_feedback }}</p>
      {% endif %}
      {% if control_status %}
        <p class="mt-3 text-success">{{ control_status }}</p>
      {% endif %}
    </div>
  </div>
  <div class="col-lg-8">
    <div class="hud-card h-100">
      <div class="hud-header">
        <h3 class="hud-title">Live Feed</h3>
        <span class="hud-badge active">VIDEO</span>
      </div>
      {% if shift.drone.video_url %}
        <img
          src="{{ shift.drone.video_url }}"
          alt="Live feed drone"
          class="img-fluid rounded border border-secondary"
          style="width: 100%; max-height: 420px; object-fit: cover;"
        />
      {% else %}
        <div class="d-flex flex-column align-items-center justify-content-center text-center p-5 border border-secondary rounded">
          <i class="fas fa-video-slash fa-2x text-muted mb-3"></i>
          <p class="text-muted mb-1">Sin stream de video configurado.</p>
          <small class="text-muted">Configura video_url en el drone.</small>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<div class="row g-4 mt-1">
  <div class="col-lg-6">
    <div class="hud-card h-100">
      <div class="hud-header">
        <h3 class="hud-title">Telemetry</h3>
        <span class="hud-badge active">LIVE DATA</span>
      </div>
      <div
        id="telemetry-panel"
        hx-get="{% url 'pilot-operation-telemetry' %}"
        hx-trigger="every 2s"
        hx-swap="innerHTML"
      >
        {% include "pilot/partials/telemetry.html" with drone=shift.drone %}
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="hud-card h-100">
      <div class="hud-header">
        <h3 class="hud-title">Operation Controls</h3>
        <span class="hud-badge alert">Actions</span>
      </div>
      <div class="d-flex flex-wrap gap-2 mb-3">
        {% if current_session %}
          <form method="post" action="{% url 'pilot-operation-end' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">End Operation</button>
          </form>
        {% else %}
          <form method="post" action="{% url 'pilot-operation-start' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-success">Start Operation</button>
          </form>
        {% endif %}
        <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#alertModal">
          Send Alert
        </button>
      </div>
      <p class="text-muted mb-1">Estado del comando:</p>
      {% if last_command %}
        <span class="badge bg-primary">{{ last_command.command }}</span>
        <span class="badge bg-secondary">{{ last_command.status }}</span>
      {% else %}
        <span class="text-muted">Sin comandos recientes.</span>
      {% endif %}
      {% if command_feedback %}
        <p class="mt-3 text-warning">{{ command_feedback }}</p>
      {% endif %}
      {% if control_status %}
        <p class="mt-3 text-success">{{ control_status }}</p>
      {% endif %}
    </div>
  </div>
</div>

<div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="alertModalLabel">Enviar alerta</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="post" action="{% url 'pilot-alert-create' %}">
          {% csrf_token %}
          {{ alert_form|crispy }}
          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Enviar alerta</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}
