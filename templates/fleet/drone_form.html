{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<h1>{% if object %}Editar{% else %}Crear{% endif %} Drone</h1>
<form method="post">
  {% csrf_token %}
  {{ form.serial|as_crispy_field }}
  {{ form.model|as_crispy_field }}
  {{ form.status|as_crispy_field }}
  <div class="mb-3">
    <label for="{{ form.api_token.id_for_label }}" class="form-label">API Token</label>
    <div class="input-group">
      {{ form.api_token }}
      <button class="btn btn-outline-secondary" type="button" id="copy-api-token">Copy</button>
    </div>
  </div>
  {{ form.last_seen|as_crispy_field }}
  {{ form.last_lat|as_crispy_field }}
  {{ form.last_lng|as_crispy_field }}
  {{ form.firmware|as_crispy_field }}
  {{ form.camera_type|as_crispy_field }}
  <button type="submit" class="btn btn-primary">Guardar</button>
</form>
{% if object %}
<form method="post" action="{% url 'admin-drone-regenerate-token' object.id %}">
  {% csrf_token %}
  <button class="btn btn-outline-warning mt-3" type="submit">Regenerate token</button>
</form>
{% endif %}
<script>
  const copyButton = document.getElementById("copy-api-token");
  const tokenInput = document.getElementById("{{ form.api_token.id_for_label }}");
  if (copyButton && tokenInput) {
    copyButton.addEventListener("click", async () => {
      if (!tokenInput.value) return;
      try {
        await navigator.clipboard.writeText(tokenInput.value);
        copyButton.textContent = "Copied!";
        setTimeout(() => {
          copyButton.textContent = "Copy";
        }, 1500);
      } catch (err) {
        copyButton.textContent = "Error";
      }
    });
  }
</script>
{% endblock %}
